# üñºÔ∏è CloudSquares Photo Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–∏ –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ `.webp` –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ JWT, –ª–∏–º–∏—Ç—ã, –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∏ –ø—É–±–ª–∏—á–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, –æ—á–µ—Ä–µ–¥–∏ —á–µ—Ä–µ–∑ Redis –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Rails API.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (.jpg, .png, .heic) –≤ `.webp`
- ‚úÖ –°–∂–∞—Ç–∏–µ –∏ —Ä–µ—Å–∞–π–∑ –¥–æ 1920px
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HEIC/HEIF (iOS)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞: public / private
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á –≤ Redis (–¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API)
- ‚úÖ –ó–∞–ø—É—Å–∫ –Ω–∞ Falcon
- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ JWT access token

---

## üì¶ –°—Ç–µ–∫

- Ruby 3.4.2
- Sinatra (API-only)
- Falcon (async web server)
- MiniMagick (ImageMagick)
- AWS S3 SDK
- Redis
- Sidekiq-compatible job push
- Dotenv

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
git clone https://your-repo-url
cd cloudsquares-photo-service

bundle install
cp .env.example .env
# –ó–∞–ø–æ–ª–Ω–∏ .env —Å–≤–æ–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```text
.
‚îú‚îÄ‚îÄ app.rb                   # Sinatra-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ config.ru                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è Falcon
‚îú‚îÄ‚îÄ .env.example             # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ jwt_decoder.rb       # –ü—Ä–æ–≤–µ—Ä–∫–∞ access_token
‚îÇ   ‚îú‚îÄ‚îÄ image_processor.rb   # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ s3_uploader.rb       # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3
‚îú‚îÄ‚îÄ uploader/
‚îÇ   ‚îî‚îÄ‚îÄ photo_uploader.rb    # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á –≤ Redis
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ environment.rb       # CORS + dotenv + rack middlewares
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Postman

### üì§ –ó–∞–ø—Ä–æ—Å: `POST /upload`

**URL:**  
`https://localhost:9292/upload` *(–∏–ª–∏ http://localhost:9292, –µ—Å–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω TLS)*

**Headers:**
```http
Authorization: Bearer <access_token>
```

**Body ‚Üí form-data:**

| –ö–ª—é—á         | –¢–∏–ø   | –û–ø–∏—Å–∞–Ω–∏–µ                                     |
|--------------|--------|----------------------------------------------|
| property_id  | Text   | UUID –æ–±—ä–µ–∫—Ç–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏                    |
| access       | Text   | public / private (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é public)       |
| is_main      | Text   | true / false (–ø–µ—Ä–≤–∞—è ‚Äî –≥–ª–∞–≤–Ω–∞—è)              |
| images       | File   | —Ñ–∞–π–ª—ã: .jpg, .png, .heic (1‚Äì30 —Ñ–∞–π–ª–æ–≤)        |

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "results": [
    {
      "status": "ok",
      "url": "https://s3.ps.kz/bucket/agency_123/property_456/public/photo1.webp"
    }
  ]
}
```

---

## üê≥ –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Falcon

```bash
bundle exec falcon serve
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞:  
`https://localhost:9292`

---

## üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–º–æ—Ç—Ä–∏ [.env.example](./.env.example)

---

## üì¨ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ access_token
2. –ö–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `.webp`
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ S3 –ø–æ –ø—É—Ç–∏:
     ```
     agency_<agency_id>/property_<property_id>/<access>/<uuid>.webp
     ```
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ –≤ Redis `queue:photo_worker` –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Rails API
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ URL –∏ —Å—Ç–∞—Ç—É—Å–æ–≤

---

## üß© –°–≤—è–∑—å —Å Rails backend

Rails API –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ Redis —á–µ—Ä–µ–∑ `Sidekiq` —Å queue `photo_worker` –∏:
- –°–æ–∑–¥–∞—ë—Ç `PropertyPhoto` (–∏–ª–∏ –¥—Ä—É–≥—É—é —Å—É—â–Ω–æ—Å—Ç—å)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∞, –ª–∏–º–∏—Ç—ã, –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
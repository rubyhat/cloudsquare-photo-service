# üñºÔ∏è CloudSquares Photo Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–∏ –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ `.webp` –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ JWT, –ª–∏–º–∏—Ç—ã, –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∏ –ø—É–±–ª–∏—á–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, –æ—á–µ—Ä–µ–¥–∏ —á–µ—Ä–µ–∑ Redis –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Rails API.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (.jpg, .png, .heic) –≤ `.webp`
- ‚úÖ –°–∂–∞—Ç–∏–µ –∏ —Ä–µ—Å–∞–π–∑ –¥–æ 1920px
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HEIC/HEIF (iOS)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞: public / private
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á –≤ Redis (–¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API)
- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (access token)
- ‚úÖ –ó–∞–ø—É—Å–∫ –Ω–∞ Falcon (async server)
- ‚úÖ REST —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —á–µ—Ä–µ–∑ Sinatra-–º–æ–¥—É–ª–∏
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ helpers / routes / services

---

## üì¶ –°—Ç–µ–∫

- Ruby 3.4.2
- Sinatra (API-only)
- Falcon (async web server)
- MiniMagick (ImageMagick)
- AWS S3 SDK
- Redis
- Dotenv
- Sidekiq-compatible queue

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
git clone https://your-repo-url
cd cloudsquares-photo-service

bundle install
cp .env.example .env
# –ó–∞–ø–æ–ª–Ω–∏ .env —Å–≤–æ–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```text
.
‚îú‚îÄ‚îÄ app.rb                         # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ Sinatra
‚îú‚îÄ‚îÄ config.ru                      # –ó–∞–ø—É—Å–∫ Falcon
‚îú‚îÄ‚îÄ .env.example                   # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ environment.rb             # dotenv + CORS + middleware
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ upload_route.rb           # POST /upload
‚îÇ   ‚îî‚îÄ‚îÄ presigned_url_route.rb    # GET /presigned-url
‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îú‚îÄ‚îÄ auth_helpers.rb           # JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ file_helpers.rb           # –ü–æ–¥—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ jwt_decoder.rb            # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ access_token
‚îÇ   ‚îú‚îÄ‚îÄ image_processor.rb        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ —Å–∂–∞—Ç–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ s3_uploader.rb            # –†–∞–±–æ—Ç–∞ —Å S3
‚îú‚îÄ‚îÄ uploader/
‚îÇ   ‚îî‚îÄ‚îÄ photo_uploader.rb         # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á –≤ Redis
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Postman

### üì§ –ó–∞–ø—Ä–æ—Å: `POST /upload`

**URL:**  
`http://localhost:9292/upload`

**Headers:**
```http
Authorization: Bearer <access_token>
```

**Body ‚Üí form-data:**

| –ö–ª—é—á         | –¢–∏–ø   | –û–ø–∏—Å–∞–Ω–∏–µ                                     |
|--------------|--------|----------------------------------------------|
| entity_type  | Text   | –¢–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: property             |
| entity_id    | Text   | UUID —Å—É—â–Ω–æ—Å—Ç–∏                                |
| access       | Text   | public / private (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é public)       |
| is_main      | Text   | true / false (–ø–µ—Ä–≤–∞—è ‚Äî –≥–ª–∞–≤–Ω–∞—è)              |
| images       | File   | —Ñ–∞–π–ª—ã: .jpg, .png, .heic (1‚Äì30 —Ñ–∞–π–ª–æ–≤)        |

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "results": [
    {
      "status": "ok",
      "url": "https://s3.ps.kz/bucket/agency_123/property_456/public/photo1.webp"
    }
  ]
}
```

---

### üîí –ó–∞–ø—Ä–æ—Å: `GET /presigned-url?key=...`

**–¢–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º —Ñ–∞–π–ª–∞–º:**

**Headers:**
```http
Authorization: Bearer <access_token>
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```
GET /presigned-url?key=agency_.../property_.../private/uuid.webp
```

**–û—Ç–≤–µ—Ç:**
```json
{ "url": "https://s3.ps.kz/..." }
```

---

## üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–º–æ—Ç—Ä–∏ [.env.example](./.env.example)

```env
JWT_SECRET=...
S3_ACCESS_KEY=...
S3_SECRET_KEY=...
S3_REGION=...
S3_BUCKET=...
S3_ENDPOINT=https://s3.ps.kz
REDIS_URL=redis://localhost:6379/0
```

---

## üß© –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

1. JWT access_token –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è
2. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç:
    - –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞
    - —Ä–µ—Å–∞–π–∑ + –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ .webp
    - –∑–∞–≥—Ä—É–∑–∫—É –≤ S3 —Å –Ω—É–∂–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º –¥–æ—Å—Ç—É–ø–∞
3. –í Redis (queue:photo_worker) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ –¥–ª—è Rails API

---

## ü§ù –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Rails backend

Rails API –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ Redis —á–µ—Ä–µ–∑ Sidekiq:
- –°–æ–∑–¥–∞—ë—Ç `PropertyPhoto` –∏–ª–∏ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å
- –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ `is_main`, `position`, `access`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç URL –≤ –±–∞–∑–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

---

## üê≥ –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Falcon

```bash
bundle exec falcon serve
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `http://localhost:9292`